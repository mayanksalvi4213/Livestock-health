{% extends "base.html" %}

{% block title %}{{ t.dashboard }} - Livestock Health{% endblock %}

{% block styles %}
<style>
    .page-header {
        background-color: var(--primary-color);
        color: white;
        padding: 20px 0;
        margin-bottom: 30px;
    }
    
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: transform 0.3s;
        margin-bottom: 20px;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .alert-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }
    
    .alert-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .alert-item {
        display: flex;
        align-items: flex-start;
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .alert-item:last-child {
        border-bottom: none;
    }
    
    .alert-severity {
        margin-right: 1rem;
        padding: 0.5rem;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        flex-shrink: 0;
    }
    
    .alert-severity-5 {
        background-color: #d32f2f;
    }
    
    .alert-severity-4 {
        background-color: #f44336;
    }
    
    .alert-severity-3 {
        background-color: #ff9800;
    }
    
    .alert-severity-2 {
        background-color: #ffca28;
    }
    
    .alert-severity-1 {
        background-color: #4caf50;
    }
    
    .alert-content {
        flex-grow: 1;
    }
    
    .alert-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .alert-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .alert-distance {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .activity-card {
        margin-bottom: 1.5rem;
    }
    
    .notifications-badge {
        position: relative;
    }
    
    .notifications-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Google Maps Styling */
    #map {
        height: 300px;
        width: 100%;
        border-radius: 0 0 12px 12px;
    }
    
    .map-info-window {
        padding: 5px;
        max-width: 250px;
    }
    
    .map-info-window h5 {
        margin-top: 0;
        margin-bottom: 8px;
        color: var(--primary-color);
        font-size: 16px;
    }
    
    .map-info-window p {
        margin-bottom: 5px;
        font-size: 13px;
    }
    
    .map-info-window .btn {
        margin-top: 5px;
    }
    
    .gm-style-iw {
        border-radius: 8px !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-4">{{ t.dashboard }}</h1>
                <p class="lead">{{ t.welcome_back }} {{ g.user.full_name }}!</p>
            </div>
            <div>
                <a href="{{ url_for('profile.index') }}" class="btn btn-outline-light me-2">
                    <i class="fas fa-cog"></i> {{ t.settings }}
                </a>

            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Main Dashboard Content -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Disease Alerts Card -->
            <div class="card alert-card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ t.disease_alerts }}
                    </h5>
                    <span class="badge bg-danger">{{ alerts_count }} {{ t.active }}</span>
                </div>
                
                <div class="card-body p-0">
                    {% if nearby_outbreaks %}
                        {% for outbreak in nearby_outbreaks %}
                        <div class="alert-item">
                            <div class="alert-severity alert-severity-{{ outbreak.severity }}">
                                <i class="fas fa-exclamation"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">{{ outbreak.disease_name }}</div>
                                <div class="alert-info">
                                    {{ outbreak.description|truncate(100) }}
                                </div>
                                <div class="alert-distance">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ "%.1f"|format(outbreak.distance) }} {{ t.km_away }} - {{ outbreak.district }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-3 text-center">
                            <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                            <p class="mb-0">{{ t.no_disease_outbreaks }}</p>
                        </div>
                    {% endif %}
                </div>
                
                {% if nearby_outbreaks %}
                <div class="card-footer text-center">
                    <a href="{{ url_for('disease_alerts.index') }}" class="btn btn-outline-success">
                        <i class="fas fa-eye me-1"></i> {{ t.view_all_alerts }}
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Nearby Veterinary Services -->
            <div class="card alert-card mt-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-hospital me-2"></i>
                        {{ t.nearby_veterinary_services }}
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-light active" id="listViewBtn">
                            <i class="fas fa-list"></i> {{ t.list_view or 'List' }}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-light" id="mapViewBtn">
                            <i class="fas fa-map-marked-alt"></i> {{ t.map_view or 'Map' }}
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- List View -->
                    <div id="vetListView">
                    {% if nearby_vets %}
                        {% for vet in nearby_vets[:3] %}
                        <div class="alert-item">
                            <div class="alert-severity bg-primary">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">{{ vet.name }}</div>
                                <div class="alert-info">
                                    <i class="fas fa-map-marker-alt me-1"></i> {{ vet.address }}
                                </div>
                                <div class="alert-distance">
                                    {% if vet.contact_number %}
                                    <i class="fas fa-phone me-1"></i> {{ vet.contact_number }} - 
                                    {% endif %}
                                    {{ "%.1f"|format(vet.distance) }} {{ t.km_away }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-3 text-center">
                            <p class="mb-0">{{ t.no_veterinary_services }}</p>
                        </div>
                    {% endif %}
                </div>
                    
                    <!-- Map View -->
                    <div id="vetMapView" style="display: none;">
                        <div id="map" style="width: 100%; height: 300px; border-radius: 0 0 12px 12px;"></div>
                    </div>
                </div>
                
                {% if nearby_vets and nearby_vets|length > 3 %}
                <div class="card-footer text-center" id="viewAllVetsBtn">
                    <a href="{{ url_for('services.veterinary_services') }}" class="btn btn-outline-success">
                        <i class="fas fa-eye me-1"></i> {{ t.view_all_services or 'View All Services' }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Farm Info Card -->
            <div class="card activity-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ t.farm_location }}
                    </h5>
                </div>
                
                <div class="card-body">
                    {% if farm %}
                    <p><strong>{{ t.address }}:</strong> <span class="translate" data-translate-key="{{ farm.address }}">{{ farm.address }}</span></p>
                    <p><strong>{{ t.district }}:</strong> <span class="translate" data-translate-key="{{ farm.district }}">{{ farm.district }}</span></p>
                    <p><strong>{{ t.state }}:</strong> <span class="translate" data-translate-key="{{ farm.state }}">{{ farm.state }}</span></p>
                    <p><strong>{{ t.pincode }}:</strong> <span class="translate" data-translate-key="{{ farm.pincode or 'Not available' }}">{{ farm.pincode or 'Not available' }}</span></p>
                    {% else %}
                    <p class="text-center text-muted">{{ t.farm_info_not_available }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle between list and map view
        const listViewBtn = document.getElementById('listViewBtn');
        const mapViewBtn = document.getElementById('mapViewBtn');
        const vetListView = document.getElementById('vetListView');
        const vetMapView = document.getElementById('vetMapView');
        const viewAllVetsBtn = document.getElementById('viewAllVetsBtn');
        
        if (listViewBtn && mapViewBtn) {
            listViewBtn.addEventListener('click', function() {
                listViewBtn.classList.add('active');
                mapViewBtn.classList.remove('active');
                vetListView.style.display = 'block';
                vetMapView.style.display = 'none';
                if (viewAllVetsBtn) viewAllVetsBtn.style.display = 'block';
            });
            
            mapViewBtn.addEventListener('click', function() {
                mapViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                vetMapView.style.display = 'block';
                vetListView.style.display = 'none';
                if (viewAllVetsBtn) viewAllVetsBtn.style.display = 'none';
                
                // Initialize map if not already initialized
                if (!window.mapInitialized) {
                    initMap();
                }
            });
        }
    });
    
    // Google Maps initialization
    let map;
    let mapInitialized = false;
    
    function initMap() {
        if (mapInitialized) return;
        
        // Create initial map with India centered
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 5,
            center: { lat: 20.5937, lng: 78.9629 }, // Center of India
            mapTypeControl: true,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true,
        });
        
        {% if farm %}
        // Get farm details
        const farmDetails = {
            address: "{{ farm.address }}",
            district: "{{ farm.district }}",
            state: "{{ farm.state }}",
            pincode: "{{ farm.pincode }}",
            lat: {% if farm.latitude %}{{ farm.latitude }}{% else %}null{% endif %},
            lng: {% if farm.longitude %}{{ farm.longitude }}{% else %}null{% endif %}
        };
        
        console.log("Farm details:", farmDetails);
        
        // If we have coordinates, use them directly
        if (farmDetails.lat && farmDetails.lng) {
            const farmLocation = { lat: farmDetails.lat, lng: farmDetails.lng };
            console.log("Using exact coordinates:", farmLocation);
            
            // Center map on farm location
            map.setCenter(farmLocation);
            map.setZoom(14);
            
            // Add marker for farm
            addFarmMarker(farmLocation);
            
            // Add nearby vet services
            {% if nearby_vets %}
            {% for vet in nearby_vets %}
            {% if vet.latitude and vet.longitude %}
            addVetMarker({
                position: { lat: {{ vet.latitude }}, lng: {{ vet.longitude }} },
                name: "{{ vet.name }}",
                address: "{{ vet.address }}",
                phone: "{{ vet.contact_number or '' }}",
                distance: {{ vet.distance }}
            });
            {% endif %}
            {% endfor %}
            {% endif %}
        } 
        // Otherwise use geocoding to find location
        else {
            const geocoder = new google.maps.Geocoder();
            
            // Build address string for geocoding
            let addressString = "";
            if (farmDetails.address) addressString += farmDetails.address + ", ";
            if (farmDetails.district) addressString += farmDetails.district + ", ";
            if (farmDetails.state) addressString += farmDetails.state + ", ";
            if (farmDetails.pincode) addressString += farmDetails.pincode + ", ";
            addressString += "India";
            
            console.log("Geocoding address:", addressString);
            
            // Geocode the address
            geocoder.geocode({ address: addressString }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const location = results[0].geometry.location;
                    console.log("Geocoding successful:", location.lat(), location.lng());
                    
                    // Center map on geocoded location
                    map.setCenter(location);
                    map.setZoom(14);
                    
                    // Add marker for farm
                    addFarmMarker(location);
                    
                    // Add nearby vet services using search
                    searchNearbyVets(location);
                } else {
                    console.error("Geocoding failed:", status);
                    document.getElementById("map").innerHTML = 
                        '<div class="p-3 text-center">' +
                        '<p>Could not find your farm location on the map. Please update your farm details with more precise information.</p>' +
                        '</div>';
                }
            });
        }
        {% else %}
        // No farm data available
        document.getElementById("map").innerHTML = 
            '<div class="p-3 text-center">' +
            '<p>Farm location data unavailable - please update your farm profile</p>' +
            '</div>';
        {% endif %}
        
        mapInitialized = true;
    }
    
    // Helper function to add farm marker
    function addFarmMarker(position) {
        const farmMarker = new google.maps.Marker({
            position: position,
            map: map,
            title: "Your Farm",
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                scaledSize: new google.maps.Size(40, 40)
            }
        });
        
        const farmInfoContent = '<div class="map-info-window">' +
            '<h5>Your Farm</h5>' +
            '<p>{{ farm.address }}, {{ farm.district }}, {{ farm.state }}</p>' +
            '{% if farm.pincode %}<p><span>Pincode</span>: {{ farm.pincode }}</p>{% endif %}' +
            '</div>';
        
        const farmInfoWindow = new google.maps.InfoWindow({
            content: farmInfoContent
        });
        
        farmMarker.addListener("click", () => {
            farmInfoWindow.open(map, farmMarker);
        });
    }
    
    // Helper function to add vet marker
    function addVetMarker(vet) {
        const vetMarker = new google.maps.Marker({
            position: vet.position,
            map: map,
            title: vet.name,
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        const vetInfoContent = '<div class="map-info-window">' +
            '<h5>' + vet.name + '</h5>' +
            '<p><i class="fas fa-map-marker-alt"></i> ' + vet.address + '</p>' +
            (vet.phone ? '<p><i class="fas fa-phone"></i> ' + vet.phone + '</p>' : '') +
            '<p><i class="fas fa-route"></i> ' + vet.distance + ' km away</p>' +
            '<p><a href="https://www.google.com/maps/dir/?api=1&destination=' + 
            vet.position.lat + ',' + vet.position.lng + 
            '" target="_blank" class="btn btn-sm btn-outline-primary">Get Directions</a></p>' +
            '</div>';
            
        const vetInfoWindow = new google.maps.InfoWindow({
            content: vetInfoContent
        });
        
        vetMarker.addListener("click", () => {
            vetInfoWindow.open(map, vetMarker);
        });
    }
    
    // Find nearby vets when coordinates aren't in database
    function searchNearbyVets(location) {
        // For locations found by geocoding, we still rely on the nearby vets from backend
        // The backend now uses Google Places API to find real vets near the farm
        {% if nearby_vets %}
        // Create positions for the veterinarians based on backend data
        const vetLocations = [
            {% for vet in nearby_vets %}
            { 
                position: { 
                    lat: {% if vet.latitude %}{{ vet.latitude }}{% else %}location.lat() + {{ loop.index0 * 0.01 - 0.01 }}{% endif %}, 
                    lng: {% if vet.longitude %}{{ vet.longitude }}{% else %}location.lng() + {{ loop.index0 * 0.01 - 0.01 }}{% endif %} 
                }, 
                name: "{{ vet.name }}",
                address: "{{ vet.address }}",
                phone: "{{ vet.contact_number or '' }}",
                distance: {{ vet.distance }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Add the vets to the map
        vetLocations.forEach(vet => addVetMarker(vet));
        {% else %}
        // When no vets data available, use geocoded location to create some defaults
        // These are displayed as a fallback if both our database and Places API return no results
        const vetLocations = [
            { 
                position: { 
                    lat: location.lat() + 0.01, 
                    lng: location.lng() + 0.015 
                }, 
                name: "District Veterinary Hospital",
                address: "Main Road, City Center",
                phone: "+91 1234567890",
                distance: 2.4
            },
            { 
                position: { 
                    lat: location.lat() - 0.008, 
                    lng: location.lng() + 0.012 
                }, 
                name: "Animal Care Center",
                address: "Near Bus Stand",
                phone: "+91 9876543210",
                distance: 1.8
            },
            { 
                position: { 
                    lat: location.lat() - 0.015, 
                    lng: location.lng() - 0.01 
                }, 
                name: "Livestock Health Center",
                address: "Rural Area",
                phone: "+91 7778889999",
                distance: 3.5
            }
        ];
        
        // Add the vets to the map
        vetLocations.forEach(vet => addVetMarker(vet));
        {% endif %}
    }
</script>

<!-- Google Maps API -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu2-A5dCNjUj53YtTd91bXsZC__az5WqM&amp;libraries=places&amp;callback=initMap">
</script>
{% endblock %}